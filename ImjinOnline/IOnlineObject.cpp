/************************************************************************************************
	だ橾貲 : IOnlineObject.cpp
	氬渡濠 : 檜彌戮

	Map縑憮 餌辨ж朝 Object 瞪羹蒂 婦葬л
************************************************************************************************/
#include <GSL.h>
#include <Main.h>
#include <OnlineWorld.h>
#include <DebugTool.h>

#include "OnlineVillage-Parser.h"
#include "OnlineObject.h"
#include "OnlinePortal-Parser.h"

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	儅撩濠.
//----------------------------------------------------------------------------------------------------------------
IOnlineObject::IOnlineObject()
{
	pOnlineObject	=	NULL;
	pTempSurface    =   NULL;
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	模資濠.
//----------------------------------------------------------------------------------------------------------------
IOnlineObject::~IOnlineObject()
{
	Free();
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	蟾晦.															
//----------------------------------------------------------------------------------------------------------------
BOOL	IOnlineObject::Init()
{
	// Surface 虜菟晦
	clGrp.CreateOffScreen(pTempSurface, 10, 10, FALSE, FALSE);
	if(pTempSurface == NULL) return FALSE;

	// 螃粽薛お曖 詭賅葬蒂 й渡и棻.
	pOnlineObject	=	new	OnlineObject[MAX_ONLINE_OBJECT];

	if(pOnlineObject)
		return TRUE;
	else
		return FALSE;
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	歜衛 Surface 橢晦
//----------------------------------------------------------------------------------------------------------------
LPDIRECTDRAWSURFACE7	IOnlineObject::GetTempSurface(void)
{
	return pTempSurface;
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	螃粽薛お虜 賅舒 餉薯
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
VOID	IOnlineObject::FreeAll()
{
	SI16	TempCount;

	for(TempCount = 0; TempCount < MAX_ONLINE_OBJECT; TempCount++)
	{
		if(pOnlineObject[TempCount].IsInit())
		{
			pOnlineObject[TempCount].Free();
		}
	}
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	螃粽薛お ж釭蒂 橈撻棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
VOID	IOnlineObject::Free(SI16 siX, SI16 siY)
{
	SI16	siID;	

	siID			=	GetObjectID(siX, siY);

	if(siID == 0)
	{		
		clGrp.Error("", "IOnlineObject::Free 螃粽薛お蒂 餉薯ж朝等 褒ぬц蝗棲棻.\n\n (Fail to release IOnlineObject::Free.)");
	}

	pOnlineObject[siID].Free();
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	螃粽薛お ж釭蒂 橈撻棻
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
VOID	IOnlineObject::Free(SI16 siID)
{
//	ASSERT2((siID > 0) && (siID < MAX_ONLINE_OBJECT), (""));
//	ASSERT((siID > 0) && (siID < MAX_ONLINE_OBJECT));

	if((siID > 0) && (siID < MAX_ONLINE_OBJECT))
		pOnlineObject[siID].Free();
}	

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	п薯
//----------------------------------------------------------------------------------------------------------------
VOID	IOnlineObject::Free()
{
	SI32	i;

	if(pOnlineObject)
	{
		for(i = 0;i < MAX_ONLINE_OBJECT; i++)		pOnlineObject[i].Free();	

		delete [] pOnlineObject;
		pOnlineObject = NULL;
	}

	if(pTempSurface)
	{
		pTempSurface->Release();

		pTempSurface    =   NULL;
	}
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	蟾晦飛 и棻.
//----------------------------------------------------------------------------------------------------------------
SI16	IOnlineObject::Init(SI32 siKind, SI16 siX, SI16 siY, cltOnlineWorld *pWorld)
{
	SI16	siID;

	siID	=	GetEmptyID();

	if(siID)
	{		
		pOnlineObject[siID].Init(siID, siKind, siX, siY, pWorld);

		return siID;
	}
	else	
		clGrp.Error("", "IOnlineObject::Init Object 寡翮檜 賅濠落棲棻.\n\n (No more space IOnlineObject::Init Object.)");

	return 0;
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お擊 蟾晦 и棻.(葆擊檣 唳辦縑虜)
//----------------------------------------------------------------------------------------------------------------
SI16	IOnlineObject::Init(VillageHeader *pVillageHeader, cltOnlineWorld *pWorld)
{		
	SI16	siID;

	siID	=	GetEmptyID();

	if(siID)
	{
		// 薯渠煎 脹 ID蒂 й渡 嫡懊棻.
		pOnlineObject[siID].Init(siID, pVillageHeader, pWorld);			
	}

	return siID;	
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お擊 蟾晦 и棻.(ん驍檣 唳辦縑虜)
//----------------------------------------------------------------------------------------------------------------
SI16	IOnlineObject::Init(PortalHeader *pPortalHeader, cltOnlineWorld *pWorld)
{		
	SI16	siID;

	siID	=	GetEmptyID();

	if(siID)
	{
		// 薯渠煎 脹 ID蒂 й渡 嫡懊棻.
		pOnlineObject[siID].Init(siID, pPortalHeader, pWorld);			
	}

	return siID;	
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	綠橫 氈朝 ID蒂 掘и棻.
//----------------------------------------------------------------------------------------------------------------
SI16	IOnlineObject::GetEmptyID()
{
	SI16	i;

	for(i = 1; i < MAX_ONLINE_OBJECT; i++)
	{
		if(pOnlineObject[i].IsInit() == FALSE)
			return i;
	}

	return 0;
}

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お擊 飛橦 斜萼棻.	
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
VOID	IOnlineObject::Draw(SI16 siID, SI16 SelectID)
{
	pOnlineObject[siID].Draw(SelectID);
}

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お擊 飛橦 Tile 寞衝戲煎 斜萼棻.	
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
VOID	IOnlineObject::DrawTileType(SI16 siID, SI16 SelectID)
{
	pOnlineObject[siID].DrawTileType(SelectID);
}

/*
//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お縑啪 樓撩檜 氈朝雖 橢橫螞棻.
//----------------------------------------------------------------------------------------------------------------
BOOL	IOnlineObject::IsAtb(SI16 siID, SI32 siAtb)
{
	return pOnlineObject[siID].IsAtb(siAtb);	
}
*/

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	葆擊檜塭賊 謙盟蒂 橢橫螞棻.
//----------------------------------------------------------------------------------------------------------------
SI32	IOnlineObject::GetVillageKind(SI16 siID)
{
	return pOnlineObject[siID].GetVillageKind();	
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お曖 檜葷擊 橢橫螞棻.
//----------------------------------------------------------------------------------------------------------------
VOID	IOnlineObject::GetName(SI16 siID, CHAR pszName[32])
{
	pOnlineObject[siID].GetName(pszName);
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お曖 撲貲擊 橢橫螞棻.
//----------------------------------------------------------------------------------------------------------------
CHAR	*IOnlineObject::GetMark(SI16 siID)															// 螃粽薛お曖 撲貲擊 橢橫螞棻.
{
	return(pOnlineObject[siID].GetMark());
}

//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お檜 氈朝 嬪纂蒂 橢橫螞棻.
//----------------------------------------------------------------------------------------------------------------
VOID	IOnlineObject::GetPos(SI16 siID, SI16 *psiX, SI16 *psiY)
{
	pOnlineObject[siID].GetPos(psiX, psiY);
}
  
//----------------------------------------------------------------------------------------------------------------
//	撲貲	:	螃粽薛お檜 離雖ж朝 艙羲擊 橢橫螞棻.
//----------------------------------------------------------------------------------------------------------------
VOID	IOnlineObject::GetSize(SI16 siID, SI16 *psiXsize, SI16 *psiYsize)
{
	pOnlineObject[siID].GetSize(psiXsize, psiYsize);
}

//--------------------------------------------------------------------------------------------------------------------------------------------------------------
//	撲貲	:	葆擊橾 唳辦 葆擊婁 翱唸腎朝 倣狨 橢橫螞棻.
//--------------------------------------------------------------------------------------------------------------------------------------------------------------
VOID	IOnlineObject::GetVillageFileName(SI16 siID, CHAR *pszVillageFileName)
{
	pOnlineObject[siID].GetVillageFileName(pszVillageFileName);
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	п渡 嬪纂縑 褕啖螳 氈朝 螃粽薛お曖 ID(寡翮醞曖 檣策蝶)蒂 橢橫螞棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
SI16	IOnlineObject::GetObjectID(SI16 siX, SI16 siY)
{
	SI32	i;
	SI16	siTempX, siTempY;

	for(i = 1; i < MAX_ONLINE_OBJECT; i++)
	{
		// 偽擎 嬪纂曖 螃粽薛お 寡翮擊 瓊朝棻.
		if(pOnlineObject[i].IsInit() == TRUE)
		{
			pOnlineObject[i].GetPos(&siTempX, &siTempY);

			if(siX == siTempX && siY == siTempY)	return i;				
		}
	}

	return 0;
}


//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	幗斜蒂 濩晦 嬪и 薑爾蒂 倣狤 噹棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
VOID	IOnlineObject::WriteFileForBug(CHAR *pszTitle)
{
	FILE	*fp;		
	SI32	i;

	fp = fopen("ObjectBug.txt", "at");
	
	fprintf(fp, "------------------------------------------------%s------------------------------------------\n", pszTitle);

	for(i = 1; i < MAX_ONLINE_OBJECT; i++)
	{
		// 偽擎 嬪纂曖 螃粽薛お 寡翮擊 瓊朝棻.
		if(pOnlineObject[i].IsInit() == TRUE)
		{
			pOnlineObject[i].WriteFileForBug(fp);
		}
	}
	fclose(fp);
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	謙盟蒂 橢橫螞棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
SI16	IOnlineObject::GetKind(SI16 siID)
{
	return pOnlineObject[siID].GetKind();
}
/*
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	謙盟蒂 橢橫螞棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
SI32	IOnlineObject::GetKindIndex(SI16 siID)
{
	return pOnlineObject[siID].GetKindIndex();
}
*/
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	螃粽薛お曖 Action.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
VOID	IOnlineObject::Action()
{
	SI32	i;

	for(i = 1; i < MAX_ONLINE_OBJECT; i++)
	{
		if(pOnlineObject[i].IsInit() == TRUE)
		{
			pOnlineObject[i].Action();
		}
	}
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	螃粽薛お陛 ん驍檣雖 匐餌и棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
BOOL	IOnlineObject::IsPortal(SI16 siID)
{
	return pOnlineObject[siID].IsPortal();
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	Portal ID蒂 給溥遽棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
SI16	IOnlineObject::GetPortalID(SI16 siID)
{
	return pOnlineObject[siID].GetPortalID();
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	Portal Name蒂 給溥遽棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
char*	IOnlineObject::GetPortalName(SI16 siID)
{
	return pOnlineObject[siID].GetPortalName();
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	Village ID蒂 給溥遽棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
UI16	IOnlineObject::GetVillageCode(SI16 siID)
{
	return pOnlineObject[siID].GetVillageCode();
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	x, y 嬪纂縑 Image陛 氈朝雖 匐餌и棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
BOOL	IOnlineObject::CheckImage(SI16 siID, SI16 x, SI16 y, LPDIRECTDRAWSURFACE7 pSurface)
{
	return pOnlineObject[siID].CheckImage(x, y, pSurface);
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	彰嬪頂縑 氈雖 彊擎 Object菟擊 餉薯и棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
void	IOnlineObject::CheckZone(SI16 sx, SI16 sy, SI16 ex, SI16 ey)
{
	SI32	i;
	SI16	siTempX, siTempY;

	for(i = 0; i < MAX_ONLINE_OBJECT; i++)
	{
		// 偽擎 嬪纂曖 螃粽薛お 寡翮擊 瓊朝棻.
		if(pOnlineObject[i].IsInit() == TRUE)
		{
			pOnlineObject[i].GetPos(&siTempX, &siTempY);

			if((siTempX < sx) || (siTempY < sy) || (siTempX > ex) || (siTempY > ey))
			{
				pOnlineObject[i].Free();
			}
		}
	}
}

//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
//	撲貲	:	Village Object蒂 瓊朝棻.
//收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收收
UI16	IOnlineObject::GetVillageObject(UI16 uiVillageCode)
{
	SI32	i;

	for(i = 1; i < MAX_ONLINE_OBJECT; i++)
	{
		if(pOnlineObject[i].IsInit())
		{
			if(pOnlineObject[i].GetVillageCode() == uiVillageCode)
			{
				return i;
			}
		}
	}

	return 0;
}
